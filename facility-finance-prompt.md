# ๐ ุฑุจุท ูุณู ุงูููุดุฃุฉ ุจุงููุงููุฉ ุงูุนุงูุฉ โ Facility to Finance Integration

## ุงูุณูุงู

ุฃูุง ุฃุนูู ุนูู ููุตุฉ **ูุณุงุฑ (Masar)** ูุฅุฏุงุฑุฉ ุงููุดุงุฑูุน ุงูุฅูุดุงุฆูุฉ. ููุฏ ุฃูุดุฃุช ูุณู **"ุงูููุดุฃุฉ"** ุงูุฐู ูุญุชูู ุนูู:
- **ุงูููุธููู** (ุฑูุงุชุจ ุดูุฑูุฉ + ุชุฃูููุงุช)
- **ุงููุตุฑููุงุช ุงูุซุงุจุชุฉ** (ุฅูุฌุงุฑุ ุงุดุชุฑุงูุงุชุ ุฎุฏูุงุช)
- **ุงูุฃุตูู ูุงููุนุฏุงุช** (ุดุฑุงุกุ ุฅููุงู)
- **ุงูุชูุงุฑูุฑ**

ุงููุดููุฉ ุงูุญุงููุฉ: ูุฐุง ุงููุณู **ูุนุฒูู ุชูุงููุง ุนู ุงููุงููุฉ ุงูุนุงูุฉ**. ูุง ุฃุณุชุทูุน ูุนุฑูุฉ:
1. ูู ุชู ุฏูุน ุงูุฑุงุชุจ ูุนูุงู ุฃู ูุงุ
2. ูู ุชู ุชุณุฌูู ุงููุตุฑูู ุงูุซุงุจุช ูู ุงููุธุงู ุงููุงููุ
3. ููู ุฃุชุชุจุน ุงูุงูุชุฒุงูุงุช ุงููุณุชุญูุฉ ูุบูุฑ ุงููุฏููุนุฉุ

---

## ุงููุทููุจ โ ูุถุน Plan Mode

**ูุง ุชูุชุจ ุฃู ููุฏ ุงูุขู.** ุฃุฑูุฏู ุฃู ุชุนูู ูู ูุถุน ุงูุชุฎุทูุท ููุท:

### ุงูุฎุทูุฉ 1: ุงูุงุณุชูุดุงู
ุงูุญุต ุงููููุงุช ุงูุชุงููุฉ ุจุนูุงูุฉ ูุจู ุฃู ุดูุก:

```
# ูุงุนุฏุฉ ุงูุจูุงูุงุช โ ุงูุฌุฏุงูู ุงูุญุงููุฉ
packages/database/prisma/schema.prisma

# ูุณู ุงูููุดุฃุฉ โ ุงูุตูุญุงุช ูุงูููููุงุช
apps/web/modules/saas/facility/
apps/web/app/(saas)/app/[organizationSlug]/facility/

# API ุงูุฎุงุต ุจุงูููุดุฃุฉ
packages/api/modules/facility/

# ุงููุงููุฉ ุงูุนุงูุฉ โ ุงูุฌุฏุงูู ูุงูู API
packages/api/modules/finance/
apps/web/modules/saas/finance/

# ุงููุตุฑููุงุช ูุงููุฏููุนุงุช ุงูุญุงููุฉ
packages/api/modules/finance/expenses/
packages/api/modules/finance/payments/
packages/api/modules/finance/banks/
packages/api/modules/finance/transfers/

# ุงูุชุฑุฌูุฉ
apps/web/modules/i18n/locales/ar.json
apps/web/modules/i18n/locales/en.json
```

### ุงูุฎุทูุฉ 2: ุชุญููู ุงููุฌูุฉ
ุจุนุฏ ูุญุต ุงูููุฏ ุงููุนููุ ุฃุฌุจ ุนู:

1. **ูุง ูู ุงูุฌุฏุงูู ุงูููุฌูุฏุฉ ูุนูุงู ูู ูุณู ุงูููุดุฃุฉุ** (ุฃุณูุงุคูุงุ ุญููููุงุ ุนูุงูุงุชูุง)
2. **ูุง ูู ุงูุฌุฏุงูู ุงููุงููุฉ ุงูููุฌูุฏุฉุ** (FinanceExpense, FinancePayment, OrganizationBank, etc.)
3. **ูู ููุฌุฏ ุฃู ุฑุจุท ุญุงูู ุจูู ุงูููุดุฃุฉ ูุงููุงููุฉุ** (foreignKey, sourceType, reference fields)
4. **ูุง ูู ุงูู API ุงูููุฌูุฏ ููู ูู ุงููุณูููุ**
5. **ูุง ูู ุญููู ุงูุญุงูุฉ (status) ุงูููุฌูุฏุฉ ูู ูู ุฌุฏููุ**

### ุงูุฎุทูุฉ 3: ูุถุน ุงูุฎุทุฉ ุงููุนูุงุฑูุฉ

ุจูุงุกู ุนูู ูุง ูุฌุฏุชู ูุนูุงู ูู ุงูููุฏุ ุตูู ุฎุทุฉ ุชุฑุจุท ุงูููุดุฃุฉ ุจุงููุงููุฉ ูููุงู ูููุจุงุฏุฆ ุงูุชุงููุฉ:

---

## ุงููุจุงุฏุฆ ุงููุนูุงุฑูุฉ (ูุฌุจ ุงูุงูุชุฒุงู ุจูุง)

### ุงููุจุฏุฃ 1: ูุตู ุงูุงุณุชุญูุงู ุนู ุงูุณุฏุงุฏ
```
ุงูุฑุงุชุจ ุงููุณุชุญู โ ุงูุฑุงุชุจ ุงููุฏููุน
ุงูุฅูุฌุงุฑ ุงููุณุชุญู โ ุงูุฅูุฌุงุฑ ุงููุฏููุน
```

ูู ุนูุตุฑ ูู ุงูููุดุฃุฉ ุนูุฏ ุงุนุชูุงุฏู ูููุดุฆ **FinanceExpense ุจุญุงูุฉ PENDING**.
ุงูุฏูุน ูุชู ููุท ูู ุฎูุงู ุงููุงููุฉ ุงูุนุงูุฉ ุนุจุฑ **FinancePayment**.

### ุงููุจุฏุฃ 2: ุงูููุดุฃุฉ = ูุตุฏุฑ ุจูุงูุงุชุ ุงููุงููุฉ = ูุตุฏุฑ ุญูููุฉ
- ูุณู ุงูููุดุฃุฉ ูููููุฏ ุงููุตุฑููุงุช
- ูุณู ุงููุงููุฉ ููุณุฌูู ุงูุฏูุน ุงููุนูู
- ูุง ููุบููุฑ ูุณู ุงูููุดุฃุฉ ุงูุฃุฑุตุฏุฉ ุงูุจูููุฉ ูุจุงุดุฑุฉ

### ุงููุจุฏุฃ 3: ุชุชุจุน ุงููุตุฏุฑ (Source Tracking)
ูู FinanceExpense ูุฌุจ ุฃู ูุญูู:
```
sourceType: 'FACILITY_PAYROLL' | 'FACILITY_RECURRING' | 'FACILITY_ASSET' | 'PROJECT' | 'MANUAL'
sourceId: string (ID ุงููุฑุฌุนู ูู ุงูุฌุฏูู ุงููุตุฏุฑ)
```

### ุงููุจุฏุฃ 4: ุญุงูุฉ ุงูุฏูุน ุงููุญุณูุจุฉ
```
remainingAmount = amount - sum(linked payments)
status:
  - PENDING (ูู ููุฏูุน ุดูุก)
  - PARTIAL (ุฏููุน ุฌุฒุก)
  - PAID (ุฏููุน ุจุงููุงูู)
  - OVERDUE (ุชุฌุงูุฒ ุชุงุฑูุฎ ุงูุงุณุชุญูุงู)
```

### ุงููุจุฏุฃ 5: ุนุฏู ุฅุถุงูุฉ GL/Journal Entries ุงูุขู
ูุง ูุฑูุฏ ูุธุงู ูููุฏ ูุญุงุณุจูุฉ ูุฒุฏูุฌ ูู ูุฐู ุงููุฑุญูุฉ. ูุฑูุฏ ููุท:
- ุฑุจุท ุงููุตุฑูู ุจุงูุฏูุน
- ุชุชุจุน ุงูุงูุชุฒุงูุงุช
- ูุนุฑูุฉ ูุง ุฏููุน ููุง ูู ููุฏูุน

---

## ุงูุณููุงุฑูููุงุช ุงููุทููุจุฉ

### ุณููุงุฑูู 1: ุฏูุฑุฉ ุญูุงุฉ ุงูุฑุงุชุจ
```
1. ุงููุญุงุณุจ ููุดุบูู ุฑูุงุชุจ ุดูุฑ ููุงูุฑ ูู ูุณู ุงูููุดุฃุฉ
2. ุงููุธุงู ูููุดุฆ FinanceExpense ููู ููุธู (ุฃู ุณุฌู ูุงุญุฏ ูุฌููุน)
   - category: SALARY
   - sourceType: FACILITY_PAYROLL
   - sourceId: payrollRunId
   - status: PENDING
   - dueDate: ููุงูุฉ ุงูุดูุฑ
3. ูู ุดุงุดุฉ ุงููุตุฑููุงุช ุงููุงููุฉ ูุธูุฑ "ุฑูุงุชุจ ููุงูุฑ - ูุณุชุญู"
4. ุงููุญุงุณุจ ูุณุฌู ุฏูุนุฉ ูู ุจูู ุงูุฑุงุฌุญู
5. FinanceExpense.status โ PAID
6. ูู ุดุงุดุฉ ุงูุฑูุงุชุจ ูุธูุฑ "ูุฏููุน โ"
```

### ุณููุงุฑูู 2: ุฏูุฑุฉ ุญูุงุฉ ุงููุตุฑูู ุงูุซุงุจุช (ุฅูุฌุงุฑ)
```
1. ุงูุฅูุฌุงุฑ ุงูุดูุฑู ูุณุฌู ูู ูุตุฑูู ูุชูุฑุฑ (3,500 ุฑ.ุณ)
2. ุจุฏุงูุฉ ูู ุดูุฑุ ุงููุธุงู ูููุดุฆ FinanceExpense ุชููุงุฆูุงู
   - category: RENT
   - sourceType: FACILITY_RECURRING
   - sourceId: recurringExpenseId
   - status: PENDING
3. ุงููุญุงุณุจ ูุฏูุน ูู ุตูุฏูู ุงูููุฏ
4. ุงูุญุงูุฉ ุชุชุญุฏุซ ุชููุงุฆูุงู
```

### ุณููุงุฑูู 3: ุดุฑุงุก ุฃุตู/ูุนุฏุฉ
```
1. ุชุณุฌูู ุดุฑุงุก ูุนุฏุฉ ุจู 50,000 ุฑ.ุณ
2. ุฅูุดุงุก FinanceExpense
   - category: EQUIPMENT
   - sourceType: FACILITY_ASSET
   - status: PENDING
3. ูููู ุงูุฏูุน ุนูู ุฏูุนุงุช (PARTIAL โ PAID)
```

---

## ุงููุฎุฑุฌุงุช ุงููุชููุนุฉ ูู ุงูุฎุทุฉ

ุงูุชุจ ุฎุทุฉ ููุตูุฉ ุชุชุถูู:

### 1. ุชุนุฏููุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช (Schema Changes)
- ูุง ุงูุญููู ุงูุชู ูุฌุจ ุฅุถุงูุชูุง ุนูู ุงูุฌุฏุงูู ุงูููุฌูุฏุฉุ
- ูู ูุญุชุงุฌ ุฌุฏุงูู ุฌุฏูุฏุฉุ
- ูุง ุงูู Enums ุงูุฌุฏูุฏุฉ ุงููุทููุจุฉุ

### 2. ุชุนุฏููุงุช API
- ูุง ุงูู procedures ุงูุฌุฏูุฏุฉ ุงููุทููุจุฉุ
- ูุง ุงูุชุนุฏููุงุช ุนูู ุงูู procedures ุงูููุฌูุฏุฉุ
- ููุทู ุงูุชุฑุญูู ุงูุชููุงุฆู (auto-generation of FinanceExpense)

### 3. ุชุนุฏููุงุช ูุงุฌูุฉ ุงููุณุชุฎุฏู
- ูุง ุงูุชุบููุฑุงุช ูู ุดุงุดุงุช ุงูููุดุฃุฉุ (ุฅุถุงูุฉ ุญุงูุฉ ุงูุฏูุนุ ุฒุฑ "ุชุฑุญูู ูููุงููุฉ")
- ูุง ุงูุชุบููุฑุงุช ูู ุดุงุดุงุช ุงููุงููุฉุ (ุนุฑุถ ุงููุตุฏุฑุ ููุชุฑ ุญุณุจ ุงูููุน)
- ุฃู ุดุงุดุงุช ุฌุฏูุฏุฉ ูุทููุจุฉุ

### 4. ุชุฑุชูุจ ุงูุชูููุฐ (Implementation Order)
ุฑุชูุจ ุงูููุงู ุจุงูุฃููููุฉ:
- Phase 1: ุชุนุฏููุงุช Schema + ุฑุจุท ุฃุณุงุณู
- Phase 2: API ููุชุฑุญูู ูุงูุฏูุน
- Phase 3: ุชุญุฏูุซ ุงููุงุฌูุงุช
- Phase 4: ุงูุชูููุฏ ุงูุชููุงุฆู ูููุตุงุฑูู ุงููุชูุฑุฑุฉ

### 5. ูููุงุช ูุญุฏุฏุฉ ููุชุนุฏูู
ููู ุชุนุฏููุ ุญุฏุฏ:
- ุงููุณุงุฑ ุงููุงูู ููููู
- ูุงุฐุง ุณูุชุบูุฑ ููู
- ุฃู ูููุงุช ุฌุฏูุฏุฉ ุณุชููุดุฃ

---

## ููุงุญุธุงุช ูููุฉ

- **ุงูุชุฒู ุจุงูููุท ุงููุนูุงุฑู ุงูุญุงูู**: oRPC ูุน protectedProcedureุ ุนุฒู ุจู organizationIdุ ูุญุต ุงูุนุถููุฉ
- **ุงูุชุฑุฌูุฉ**: ุฃุถู ุงูููุงุชูุญ ุงูุนุฑุจูุฉ ูุงูุฅูุฌููุฒูุฉ ููู ูุต ุฌุฏูุฏ
- **RTL**: ูู ุงููุงุฌูุงุช ูุฌุจ ุฃู ุชุฏุนู ุงูุนุฑุจูุฉ
- **ูุง ุชูุณุฑ ุดูุก ููุฌูุฏ**: ุฃู ุชุนุฏูู ุนูู FinanceExpense ูุฌุจ ุฃู ูููู backward compatible
- **Zod validation**: ูู input ุฌุฏูุฏ ูุฌุจ ุฃู ููุฑ ุจู Zod schema
- **ุงูุตูุงุญูุงุช**: ุชุญูู ุฃู ุงููุณุชุฎุฏู ูุฏูู ุตูุงุญูุฉ finance ุฃู facility

---

## ุงุจุฏุฃ ุงูุขู ุจุงูุงุณุชูุดุงู ุซู ุฃุนุทูู ุงูุฎุทุฉ ุงููุงููุฉ.
